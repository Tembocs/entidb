# EntiDB Production-Readiness TODO (02 Jan 2025 - 1)

This file records confirmed production-readiness findings and the single best proposed fix for each (no alternative options listed).

## 1) Single-writer invariant is not enforced

**Finding**

- `Database::transaction` uses `Transaction`, which supports writes without holding the exclusive write lock.
- This allows concurrent writers and can lead to lost updates.

**Evidence**

- `crates/entidb_core/src/database.rs:823`
- `crates/entidb_core/src/transaction/state.rs:259`

**Best solution**

- Make `Transaction` read-only and require `WriteTransaction` for all writes so the type system enforces single-writer semantics.

## 2) Index maintenance is not atomic with commit

**Finding**

- Commits append to segments but index updates are manual and FTS indexes are in-memory only.
- Index state can become stale and is not guaranteed atomic with commit.

**Evidence**

- `crates/entidb_core/src/transaction/manager.rs:260`
- `crates/entidb_core/src/database.rs:1642`
- `crates/entidb_core/src/database.rs:1966`

**Best solution**

- Integrate index updates into commit using the write set, and rebuild/update indexes from WAL/segments so index state is always derivable and atomic.

## 3) Sync server is non-durable and uses non-cryptographic conflict hashes

**Finding**

- The sync server oplog is in-memory only.
- Conflict detection uses a non-cryptographic hash.

**Evidence**

- `crates/entidb_sync_server/src/oplog.rs:14`
- `crates/entidb_sync_server/src/oplog.rs:156`

**Best solution**

- Back the sync server with `entidb_core` for durable oplog/entity state and compute conflicts using SHA-256 over canonical CBOR bytes.

## 4) Manifest and segment metadata are not made durable at the directory level

**Finding**

- Manifest saves rely on rename without fsyncing the directory.
- Segment deletes do not fsync the directory, risking metadata loss on crash.

**Evidence**

- `crates/entidb_core/src/dir.rs:182`
- `crates/entidb_core/src/dir.rs:228`

**Best solution**

- Fsync the database directory after manifest rename and after segment file create/delete operations so metadata updates are crash-safe.

## 5) Backups are not snapshot-consistent and omit metadata

**Finding**

- Backup scans all records without filtering by snapshot sequence.
- Backups omit manifest/index metadata, so restore can write into collections not present in the manifest.

**Evidence**

- `crates/entidb_core/src/backup.rs:130`
- `crates/entidb_core/src/backup.rs:136`
- `crates/entidb_core/src/database.rs:1368`

**Best solution**

- Implement a snapshot-consistent, streaming backup format that filters by commit sequence and embeds the manifest (collections + index definitions), restoring metadata before data.

## 6) Deprecated collection API silently falls back to in-memory

**Finding**

- `Database::collection` falls back to in-memory on manifest persistence failure.
- This makes behavior implicit and risks durable data loss.

**Evidence**

- `crates/entidb_core/src/database.rs:992`

**Best solution**

- Remove the fallback and make collection creation strictly fallible (use only `create_collection`), so persistence errors are explicit.

## 7) Read-only transactions write BEGIN records and are not auto-cleaned

**Finding**

- Read-only transactions append BEGIN records to the WAL.
- There is no RAII cleanup to remove active transactions when dropped.

**Evidence**

- `crates/entidb_core/src/transaction/manager.rs:87`

**Best solution**

- Separate read-only transactions that do not write to the WAL and add RAII cleanup to remove active transactions without relying on fallible abort.

## 8) Checkpoint interval config is unused

**Finding**

- `checkpoint_interval` exists but is never applied.

**Evidence**

- `crates/entidb_core/src/config.rs:20`

**Best solution**

- Implement a background scheduler that triggers checkpoints on the configured interval, or remove the option until implemented.

## 9) Fuzz targets are not wired into CI

**Finding**

- Fuzz harnesses exist but are not executed in CI.

**Evidence**

- `crates/entidb_testkit/src/fuzz.rs:1`
- `.github/workflows/ci.yml:1`

**Best solution**

- Add a periodic fuzzing job (nightly/cron) with a bounded time budget and saved corpora.
